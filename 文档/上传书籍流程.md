## 书籍上传流程说明

### 整体流程图

```mermaid
graph TD
    A[开始上传] --> B[本地解析EPUB]
    B --> C{会话验证}
    C -->|失败| D[刷新会话]
    D -->|成功| E[准备上传数据]
    D -->|失败| Z[提示重新登录]
    C -->|成功| E
    E --> F[上传到服务器]
    F --> G{上传结果}
    G -->|成功| H[合并数据]
    G -->|失败且会话过期| I[刷新会话重试]
    I --> F
    G -->|其他失败| J[显示错误]
    H --> K[加载书籍]
    K --> L[结束]
    J --> L
    Z --> L
```

### 本地解析EPUB流程

```mermaid
graph TD
    A[读取EPUB文件] --> B[解析元数据]
    B --> C[提取章节内容]
    C --> D[收集资源文件]
    D --> E[生成本地书籍对象]
    E --> F[返回解析结果]
```

### 服务器处理流程

```mermaid
graph TD
    A[接收上传请求] --> B[验证用户身份]
    B --> C[生成唯一书籍ID]
    C --> D[上传EPUB到OSS]
    D --> E[处理章节数据]
    E --> F[处理资源文件]
    F --> G[保存书籍信息]
    G --> H[保存章节信息]
    H --> I[保存资源信息]
    I --> J[返回处理结果]
```

### 资源处理流程

```mermaid
graph TD
    A[收集资源引用] --> B[解压EPUB文件]
    B --> C[遍历资源列表]
    C --> D{查找资源文件}
    D -->|找到| E[上传到OSS]
    D -->|未找到| F[尝试其他路径]
    F --> D
    E --> G[更新资源记录]
    G --> H[下一个资源]
    H --> C
```

### 数据合并流程

```mermaid
graph TD
    A[获取本地数据] --> B[获取服务器数据]
    B --> C[合并基本信息]
    C --> D[合并资源信息]
    D --> E[更新资源路径]
    E --> F[返回完整书籍对象]
```

## 关键步骤说明

1. **本地解析**
   - 解析EPUB文件获取基本信息
   - 提取章节内容和资源引用
   - 生成本地书籍对象

2. **会话管理**
   - 验证当前会话
   - 必要时刷新会话
   - 处理认证错误

3. **资源处理**
   - 收集所有资源引用
   - 处理图片等媒体文件
   - 上传到OSS存储
   - 记录资源映射关系

4. **数据存储**
   - 保存书籍基本信息
   - 保存章节内容
   - 保存资源记录
   - 建立关联关系

5. **错误处理**
   - 会话过期处理
   - 上传失败重试
   - 资源处理异常
   - 数据存储错误

## 注意事项

1. 资源路径处理
   - 支持多种可能的路径格式
   - 处理EPUB中的相对路径
   - 确保资源正确映射

2. 数据完整性
   - 使用事务确保数据一致性
   - 保持资源引用的完整性
   - 确保关联关系正确

3. 性能优化
   - 批量处理资源上传
   - 优化数据库操作
   - 合理使用缓存

4. 安全性
   - 严格的用户认证
   - 文件类型验证
   - 资源访问控制 