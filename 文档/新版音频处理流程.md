# 新版音频处理流程

## 概述

新版音频处理流程彻底革新了原有的语音识别和文本对齐方式，通过集成Rev AI的强制对齐技术，实现了精确的音频文本对齐功能。

## 核心改进

### 🎯 **精确对齐**
- 使用Rev AI的强制对齐技术，而不是依赖阿里云NLS的自动句子划分
- 用户可以自主选择需要对齐的语境块范围
- 获得毫秒级精确的单词时间戳

### 🎨 **直观交互**
- 可视化的语境块选择界面
- 实时的状态反馈和进度显示
- 优雅的动画效果和视觉提示

### 🔄 **一体化流程**
- 上传音频 → 选择语境块 → AI对齐 → 数据写入，一气呵成
- 无需复杂的拖拽操作和手动匹配
- 自动处理句子切割和数据库写入

## 详细流程

### 1. 音频上传阶段

**用户操作**：
- 点击音频处理右侧栏
- 点击"选择音频文件"按钮
- 选择MP3/WAV格式的音频文件

**系统处理**：
- 上传音频到OSS存储
- 创建speech_result记录
- 获取音频时长信息
- 状态切换到"uploaded"

### 2. 语境块选择阶段

**起始块选择**：
- 用户点击"选择语境范围"按钮
- 系统播放音频开始10秒片段
- 语音提示："请选择起始语境块"
- 左侧语境块显示橙色高亮选择状态
- 用户点击目标语境块

**结束块选择**：
- 系统播放音频结束前10秒片段
- 语音提示："请选择结束语境块"
- 左侧语境块显示绿色高亮选择状态
- 用户点击目标语境块

### 3. Rev AI处理阶段

**数据准备**：
- 提取选中范围内的所有语境块文本
- 合并为完整的转录文本
- 调用Rev AI强制对齐API

**AI处理**：
- 提交音频URL和转录文本到Rev AI
- 等待处理完成（通常1-3分钟）
- 获取精确的单词级时间戳

### 4. 数据写入阶段

**并行处理**：
- 句子切割：根据标点符号智能分割句子
- 数据库写入：批量插入sentences和words表
- 语境块更新：转换为audio_aligned类型

**关联建立**：
- 创建block_sentences关联表记录
- 更新语境块的时间范围信息
- 设置conversion_status为completed

## 技术架构

### 前端组件

#### AudioProcessingPanel
- 主要的音频处理界面组件
- 管理整个流程的状态机
- 提供视觉反馈和用户交互

#### ContextBlocks (增强版)
- 添加语境块选择功能
- 支持选择模式的视觉效果
- 监听选择事件并提供反馈

### 后端API

#### /api/rev-ai-alignment
- 处理Rev AI强制对齐请求
- 管理任务提交和状态轮询
- 返回精确的时间戳数据

#### /api/audio/upload (复用)
- 音频文件上传处理
- 创建speech_result记录
- 返回音频URL和元数据

### 数据库结构

#### 核心表更新
```sql
-- speech_results: 音频记录
-- sentences: 句子级时间戳
-- words: 单词级时间戳  
-- context_blocks: 语境块(转换为audio_aligned)
-- block_sentences: 语境块与句子的关联
```

## 用户体验优化

### 视觉效果
- **选择模式**：语境块显示彩色边框和动画
- **进度指示**：实时显示处理进度
- **状态反馈**：每个阶段都有明确的视觉提示

### 交互优化
- **一键操作**：减少复杂的拖拽操作
- **智能提示**：语音和文字双重提示
- **错误处理**：友好的错误信息和重试机制

### 性能优化
- **并行处理**：句子切割和数据写入并行执行
- **批量操作**：数据库批量插入提高效率
- **缓存机制**：避免重复处理相同音频

## 配置要求

### 环境变量
```bash
REV_AI_Access_Token=your_rev_ai_token
```

### 依赖服务
- Rev AI API (强制对齐)
- Supabase (数据存储)
- OSS (音频存储)

## 测试页面

访问 `/audio-processing-test` 页面可以体验完整的音频处理流程：

1. 自动创建测试数据
2. 模拟完整的交互流程
3. 验证数据写入结果

## 与旧版本的对比

| 特性 | 旧版本 | 新版本 |
|------|--------|--------|
| 句子划分 | 被动接受NLS结果 | 主动选择语境范围 |
| 对齐精度 | 句子级，存在误差 | 单词级，毫秒精确 |
| 用户操作 | 复杂的拖拽匹配 | 简单的点击选择 |
| 处理时间 | 需要多次调整 | 一次性完成 |
| 数据质量 | 依赖算法推测 | 基于准确文本 |

## 未来扩展

### 多语言支持
- 扩展到中文、日语等其他语言
- 适配不同语言的句子切割规则

### 批量处理
- 支持多个音频文件的批量处理
- 自动检测和匹配对应的文本内容

### 实时预览
- 在选择语境块时实时播放对应音频片段
- 提供更直观的选择体验

## 总结

新版音频处理流程通过引入Rev AI的强制对齐技术，彻底解决了原有系统中句子划分不准确的问题。用户现在可以：

1. **精确控制**：自主选择需要对齐的文本范围
2. **高质量结果**：获得毫秒级精确的时间戳
3. **简化操作**：一键完成整个对齐流程
4. **可靠性**：基于准确文本的强制对齐，避免识别错误

这个革命性的改进将大大提升用户的音频学习体验，为后续的逐句点读、语音学习等功能奠定了坚实的基础。 